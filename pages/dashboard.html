
<!doctype html><html lang="es"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard</title><link rel="stylesheet" href="../css/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import {loadJSON} from "../js/utils.js";

function promedio(vals){
  const nums = Object.values(vals).map(Number).filter(v=>!isNaN(v)&&v>0);
  if(!nums.length) return 0;
  return nums.reduce((a,b)=>a+b,0)/nums.length;
}

function buildKPSI(){
  const d = loadJSON("kpsi_data",{registros:[]}).registros;
  const inicio = d.filter(r=>r.fase==="inicio");
  const fin = d.filter(r=>r.fase==="fin");
  const mInicio = inicio.map(r=>promedio(r.vals));
  const mFin = fin.map(r=>promedio(r.vals));
  const labels = [...Array(Math.max(mInicio.length, mFin.length)).keys()].map(i=>`R${i+1}`);

  const ctx = document.getElementById("kpsi").getContext("2d");
  new Chart(ctx, {
    type:"line",
    data:{labels, datasets:[
      {label:"KPSI Inicio (promedio menor=mejor)", data:mInicio},
      {label:"KPSI Fin (promedio menor=mejor)", data:mFin}
    ]},
    options:{responsive:true}
  });
}

function buildQuiz(){
  const d = loadJSON("quiz_data",{registros:[]}).registros;
  const labels = d.map(r=>new Date(r.ts).toLocaleString());
  const data = d.map(r=>r.pct);
  const ctx = document.getElementById("quiz").getContext("2d");
  new Chart(ctx, {type:"bar", data:{labels, datasets:[{label:"% Quiz", data}]}, options:{responsive:true}});
}

window.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("btnPDF").addEventListener("click", async ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const area = document.querySelector("main");
    const c1 = document.getElementById("kpsi");
    const c2 = document.getElementById("quiz");
    const img1 = c1.toDataURL("image/png");
    const img2 = c2.toDataURL("image/png");
    doc.text("Reporte â€” Proyecto X", 10, 10);
    doc.addImage(img1, "PNG", 10, 14, 180, 80);
    doc.addPage();
    doc.addImage(img2, "PNG", 10, 14, 180, 80);
    const pdf = doc.output("datauristring");
    try{
      await sendEmailWithAttachment("[Piloto] Reporte Dashboard", "Adjunto PDF con grÃ¡ficos KPSI/Quiz.", pdf);
      alert("Reporte enviado con EmailJS");
    }catch(e){ console.error(e); alert("Error al enviar con EmailJS"); }
  });
  buildKPSI();
  buildQuiz();
});
</script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script></head>
<body>
<header><div class="container"><a href="../index.html" class="btn ghost">â¬…ï¸ Volver</a>  <strong style="margin-left:12px">Dashboard</strong></div></header>
<main class="container grid"><script type="module">import {initGlobalUI, sendEmailWithAttachment} from "../js/app.js"; window.addEventListener("DOMContentLoaded", initGlobalUI);</script>
  <div class="card"><h3>âœ… KPSI â€” promedio por registro</h3><canvas id="kpsi" height="200"></canvas></div>
  <div class="card"><h3>ğŸ§ª Quiz â€” % de logro</h3><canvas id="quiz" height="200"></canvas></div>
  <p class="alert ok">InterpretaciÃ³n: en KPSI, valores mÃ¡s bajos indican mayor dominio (1=mejor).</p>
<div class="toolbar"><button class="btn" id="btnPDF">ğŸ“„ Generar PDF + Enviar</button></div></main> <footer class="footer">
  <div>ğŸ“š<strong>Â© Neotech EduLab â€” EducaciÃ³n Inmersiva </strong></div>
  <div>ğŸ› ï¸Prohibida su copia y/o reproduccion</div>
  </footer>
<script type="module">import {initGlobalUI} from "../js/app.js"; initGlobalUI();</script>
<script>
// Fallback for local file:// where ES modules may be blocked
(function(){
  function inject(){
    var container = document.querySelector("header .container");
    if(!container) return;
    if(container.querySelector(".header-controls")) return;
    var bar = document.createElement("div");
    bar.className = "header-controls";
    bar.innerHTML = '<div class="header-spacer"></div>' +
      '<a class="ctrl" href="index.html" title="Inicio">ğŸ </a>' +
      '<button class="ctrl" title="Narrador" onclick="window._tts=!window._tts; try{var u=new SpeechSynthesisUtterance(window._tts?\'Narrador activado\':\'Narrador desactivado\'); u.lang=\'es-CL\'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){}">ğŸ—£ï¸</button>' +
      '<button class="ctrl" title="Claro/Oscuro" onclick="document.documentElement.classList.toggle(\'light\')">ğŸŒ“</button>' +
      '<button class="ctrl" title="Aumentar letra" onclick="(function(){var r=document.documentElement;var s=parseFloat(getComputedStyle(r).getPropertyValue(\'--scale\')||\'1\');r.style.setProperty(\'--scale\', String(Math.min(1.6,s+0.1)));})();">A+</button>' +
      '<button class="ctrl" title="Disminuir letra" onclick="(function(){var r=document.documentElement;var s=parseFloat(getComputedStyle(r).getPropertyValue(\'--scale\')||\'1\');r.style.setProperty(\'--scale\', String(Math.max(0.8,s-0.1)));})();">Aâˆ’</button>' +
      '<button class="ctrl" title="Idioma" onclick="alert(\'Idioma (placeholder)\')">ğŸŒ</button>' +
      '<button class="ctrl" title="Accesibilidad" onclick="document.documentElement.classList.toggle(\'hc\')">ğŸ§ </button>' +
      '<button class="ctrl" title="Buscar" onclick="(function(){var q=prompt(\'Buscar:\'); if(!q) return; document.querySelectorAll(\'.card,h2,h3\').forEach(function(el){var t=(el.innerText||\'\').toLowerCase(); el.style.outline=t.includes(q.toLowerCase())?\'2px solid var(--accent-2)\':\'\'; el.style.opacity=t.includes(q.toLowerCase())?\'1\':\'0.4\';});})();">ğŸ”</button>';
    container.appendChild(bar);
  }
  if(document.readyState!=="loading") inject();
  else document.addEventListener("DOMContentLoaded", inject);
})();
</script>

</body></html>
