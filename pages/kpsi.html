
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KPSI ‚Äî Fotos√≠ntesis</title><link rel="stylesheet" href="../css/style.css"/>
<script type="module">
import {saveJSON, loadJSON, toCSV, download, sendMail, ts} from "../js/utils.js";
import {initGlobalUI, studentFieldsHTML, getStudent, sendEmailWithAttachment} from "../js/app.js";

const scale = [
  {k:1, t:"Lo s√© y puedo explicarlo a un compa√±ero"},
  {k:2, t:"No estoy seguro, no podr√≠a explic√°rselo"},
  {k:3, t:"No lo entiendo"},
  {k:4, t:"No lo s√©"}
];

const items = [
  {id:"fot_concepto", txt:"Explico qu√© es la fotos√≠ntesis y su ecuaci√≥n general"},
  {id:"fot_cloroplasto", txt:"Identifico cloroplastos, tilacoides y estroma"},
  {id:"fot_luz", txt:"Diferencio fase luminosa y oscura (Ciclo de Calvin)"},
  {id:"fot_gases", txt:"Relaciono intercambio de CO‚ÇÇ/O‚ÇÇ con estomas"},
  {id:"fot_factores", txt:"Predigo c√≥mo luz, CO‚ÇÇ y temperatura afectan tasa fotosint√©tica"},
  {id:"fot_energia", txt:"Describo flujo de energ√≠a: luz ‚Üí ATP/NADPH ‚Üí glucosa"}
];

let mode = "inicio"; // or "fin"
let area = "PIE"; // PIE, TEA, 1-2, Fono

function render(){
  document.querySelector("#when").textContent = mode === "inicio" ? "Inicio" : "Fin";
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";
  for(const it of items){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${it.txt}</td>` + scale.map(s => 
      `<td><label class="toggle"><input type="radio" name="${it.id}" value="${s.k}"><span>${s.k}</span></label></td>`
    ).join("");
    tbody.appendChild(tr);
  }
}

function collect(){
  const vals = {};
  for(const it of items){
    const v = document.querySelector(`input[name='${it.id}']:checked`);
    vals[it.id] = v ? Number(v.value) : "";
  }
  return vals;
}

function save(){
  const alumno = getStudent();
  const data = loadJSON("kpsi_data", {registros:[]});
  data.registros.push({ alumno,
    ts: ts(),
    fase: mode,
    area,
    vals: collect()
  });
  saveJSON("kpsi_data", data);
  alert("Guardado ‚úì");
}

function exportCSV(){
  const data = loadJSON("kpsi_data", {registros:[]});
  const rows = [];
  for(const r of data.registros){
    const base = {timestamp:r.ts, fase:r.fase, area:r.area};
    for(const it of items){
      base[it.id] = r.vals[it.id] ?? "";
    }
    rows.push(base);
  }
  const csv = toCSV(rows);
  download(`kpsi_${Date.now()}.csv`, csv);
}

async function mail(){
  const data = loadJSON("kpsi_data", {registros:[]});
  const ultimo = data.registros[data.registros.length-1];
  const body = JSON.stringify(ultimo, null, 2);
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text('KPSI ‚Äî Proyecto X',10,10);
    doc.text(`Fase: ${'${mode}'} ¬∑ √Årea: ${'${area}'}`,10,18);
    doc.text(body.substring(0,1000),10,28);
    const pdf = doc.output('datauristring');
    await sendEmailWithAttachment(`[Piloto] KPSI ${'${mode}'} ‚Äî ${'${area}'}`, body, pdf);
    alert('Enviado con EmailJS');
  }catch(e){
    console.error(e); alert('Error al enviar con EmailJS');
  }
}

window.addEventListener("DOMContentLoaded", ()=>{
  initGlobalUI();
  document.getElementById('studentFields').innerHTML = studentFieldsHTML();
  render();
  document.querySelector("#fase").addEventListener("change", e=>{ mode = e.target.value; render(); });
  document.querySelector("#area").addEventListener("change", e=>{ area = e.target.value; });
  document.querySelector("#btnSave").addEventListener("click", save);
  document.querySelector("#btnCSV").addEventListener("click", exportCSV);
  document.querySelector("#btnMail").addEventListener("click", mail);
});
</script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script></head>
<body>
<header><div class="container"><a href="../index.html" class="btn ghost">‚¨ÖÔ∏è Volver</a>  <strong style="margin-left:12px">KPSI ¬∑ Fotos√≠ntesis</strong></div></header>
<main class="container">
  <div class="toolbar"><script type="module">import {initGlobalUI,studentFieldsHTML,getStudent,sendEmailWithAttachment} from "../js/app.js";</script>
    <label>Fase:
      <select id="fase">
        <option value="inicio">Inicio</option>
        <option value="fin">Fin</option>
      </select>
    </label>
    <label>√Årea:
      <select id="area">
        <option>PIE</option>
        <option>TEA</option>
        <option>1-2</option>
        <option>Fono</option>
      </select>
    </label>
    <button class="btn" id="btnSave">‚úÖ Guardar</button>
    <button class="btn secondary" id="btnCSV">‚úÖ CSV</button>
    <button class="btn ghost" id="btnMail">‚úâÔ∏è Enviar</button>
  </div>
  <div class="card" id="alumno_box" data-say="Datos del estudiante"><h3>üë§ Datos del estudiante</h3><div id="studentFields"></div></div>
  <table class="table">
    <thead><tr><th>√çtem</th><th>1</th><th>2</th><th>3</th><th>4</th></tr></thead>
    <tbody></tbody>
  </table>

  <p class="alert info">Escala: 1=Lo s√© y puedo explicarlo ¬∑ 2=No estoy seguro ¬∑ 3=No lo entiendo ¬∑ 4=No lo s√©</p>
  <p>Aplica KPSI de diagn√≥stico/egreso (inicio/fin). Exporta CSV para tu Dashboard.</p>
<form id="kpsiForm" class="card">
  <label>Nombre estudiante <input name="nombre" required/></label><br/><br/>
  <table style="width:100%" aria-label="KPSI">
    <thead><tr><th>√çtem</th><th>1 Lo s√©</th><th>2 No seguro</th><th>3 No lo entiendo</th><th>4 No lo s√©</th></tr></thead>
    <tbody>
      <tr><td>Rol de la luz en fotos√≠ntesis</td><td><input type="radio" name="i1" value="1" required/></td><td><input type="radio" name="i1" value="2"/></td><td><input type="radio" name="i1" value="3"/></td><td><input type="radio" name="i1" value="4"/></td></tr>
      <tr><td>Entrada de CO‚ÇÇ / H‚ÇÇO</td><td><input type="radio" name="i2" value="1" required/></td><td><input type="radio" name="i2" value="2"/></td><td><input type="radio" name="i2" value="3"/></td><td><input type="radio" name="i2" value="4"/></td></tr>
      <tr><td>Producto O‚ÇÇ / Glucosa</td><td><input type="radio" name="i3" value="1" required/></td><td><input type="radio" name="i3" value="2"/></td><td><input type="radio" name="i3" value="3"/></td><td><input type="radio" name="i3" value="4"/></td></tr>
    </tbody>
  </table>
  <br/>
  <button class="ctrl" type="button" onclick="exportKPSI()">‚úÖ Exportar CSV</button>
  <a class="ctrl" href="../docs/KPSI.pdf" target="_blank" rel="noopener">üìÑ Leer documento base (PDF)</a>
</form>

</main>
 <footer class="footer">
  <div>üìö<strong>¬© Neotech EduLab ‚Äî Educaci√≥n Inmersiva </strong></div>
  <div>üõ†Ô∏èProhibida su copia y/o reproduccion</div>
  </footer>
<script type="module">import {initGlobalUI} from "../js/app.js"; initGlobalUI();</script></body>
</html>
