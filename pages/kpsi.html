
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KPSI â€” FotosÃ­ntesis</title><link rel="stylesheet" href="../css/style.css"/>
<script type="module">
import {saveJSON, loadJSON, toCSV, download, sendMail, ts} from "../js/utils.js";
import {initGlobalUI, studentFieldsHTML, getStudent, sendEmailWithAttachment} from "../js/app.js";

const scale = [
  {k:1, t:"Lo sÃ© y puedo explicarlo a un compaÃ±ero"},
  {k:2, t:"No estoy seguro, no podrÃ­a explicÃ¡rselo"},
  {k:3, t:"No lo entiendo"},
  {k:4, t:"No lo sÃ©"}
];

const items = [
  {id:"fot_concepto", txt:"Explico quÃ© es la fotosÃ­ntesis y su ecuaciÃ³n general"},
  {id:"fot_cloroplasto", txt:"Identifico cloroplastos, tilacoides y estroma"},
  {id:"fot_luz", txt:"Diferencio fase luminosa y oscura (Ciclo de Calvin)"},
  {id:"fot_gases", txt:"Relaciono intercambio de COâ‚‚/Oâ‚‚ con estomas"},
  {id:"fot_factores", txt:"Predigo cÃ³mo luz, COâ‚‚ y temperatura afectan tasa fotosintÃ©tica"},
  {id:"fot_energia", txt:"Describo flujo de energÃ­a: luz â†’ ATP/NADPH â†’ glucosa"}
];

let mode = "inicio"; // or "fin"
let area = "PIE"; // PIE, TEA, 1-2, Fono

function render(){
  document.querySelector("#when").textContent = mode === "inicio" ? "Inicio" : "Fin";
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";
  for(const it of items){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${it.txt}</td>` + scale.map(s => 
      `<td><label class="toggle"><input type="radio" name="${it.id}" value="${s.k}"><span>${s.k}</span></label></td>`
    ).join("");
    tbody.appendChild(tr);
  }
}

function collect(){
  const vals = {};
  for(const it of items){
    const v = document.querySelector(`input[name='${it.id}']:checked`);
    vals[it.id] = v ? Number(v.value) : "";
  }
  return vals;
}

function save(){
  const alumno = getStudent();
  const data = loadJSON("kpsi_data", {registros:[]});
  data.registros.push({ alumno,
    ts: ts(),
    fase: mode,
    area,
    vals: collect()
  });
  saveJSON("kpsi_data", data);
  alert("Guardado âœ“");
}

function exportCSV(){
  const data = loadJSON("kpsi_data", {registros:[]});
  const rows = [];
  for(const r of data.registros){
    const base = {timestamp:r.ts, fase:r.fase, area:r.area};
    for(const it of items){
      base[it.id] = r.vals[it.id] ?? "";
    }
    rows.push(base);
  }
  const csv = toCSV(rows);
  download(`kpsi_${Date.now()}.csv`, csv);
}

async function mail(){
  const data = loadJSON("kpsi_data", {registros:[]});
  const ultimo = data.registros[data.registros.length-1];
  const body = JSON.stringify(ultimo, null, 2);
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text('KPSI â€” Proyecto X',10,10);
    doc.text(`Fase: ${'${mode}'} Â· Ãrea: ${'${area}'}`,10,18);
    doc.text(body.substring(0,1000),10,28);
    const pdf = doc.output('datauristring');
    await sendEmailWithAttachment(`[Piloto] KPSI ${'${mode}'} â€” ${'${area}'}`, body, pdf);
    alert('Enviado con EmailJS');
  }catch(e){
    console.error(e); alert('Error al enviar con EmailJS');
  }
}

window.addEventListener("DOMContentLoaded", ()=>{
  initGlobalUI();
  document.getElementById('studentFields').innerHTML = studentFieldsHTML();
  render();
  document.querySelector("#fase").addEventListener("change", e=>{ mode = e.target.value; render(); });
  document.querySelector("#area").addEventListener("change", e=>{ area = e.target.value; });
  document.querySelector("#btnSave").addEventListener("click", save);
  document.querySelector("#btnCSV").addEventListener("click", exportCSV);
  document.querySelector("#btnMail").addEventListener("click", mail);
});
</script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script></head>
<body>
<header><div class="container"><a href="../index.html" class="btn ghost">â¬…ï¸ Volver</a>  <strong style="margin-left:12px">KPSI Â· FotosÃ­ntesis</strong></div></header>
<main class="container">
  <div class="toolbar"><script type="module">import {initGlobalUI,studentFieldsHTML,getStudent,sendEmailWithAttachment} from "../js/app.js";</script>
    <label>Fase:
      <select id="fase">
        <option value="inicio">Inicio</option>
        <option value="fin">Fin</option>
      </select>
    </label>
    <label>Ãrea:
      <select id="area">
        <option>PIE</option>
        <option>TEA</option>
        <option>1-2</option>
        <option>Fono</option>
      </select>
    </label>
    <button class="btn" id="btnSave">âœ… Guardar</button>
    <button class="btn secondary" id="btnCSV">âœ… CSV</button>
    <button class="btn ghost" id="btnMail">âœ‰ï¸ Enviar</button>
  </div>
  <div class="card" id="alumno_box" data-say="Datos del estudiante"><h3>ğŸ‘¤ Datos del estudiante</h3><div id="studentFields"></div></div>
  <table class="table">
    <thead><tr><th>Ãtem</th><th>1</th><th>2</th><th>3</th><th>4</th></tr></thead>
    <tbody></tbody>
  </table>

  <p class="alert info">Escala: 1=Lo sÃ© y puedo explicarlo Â· 2=No estoy seguro Â· 3=No lo entiendo Â· 4=No lo sÃ©</p>
</main>
 <footer class="footer">
  <div>ğŸ“š<strong>Â© Neotech EduLab â€” EducaciÃ³n Inmersiva </strong></div>
  <div>ğŸ› ï¸Prohibida su copia y/o reproduccion</div>
  </footer>
<script type="module">import {initGlobalUI} from "../js/app.js"; initGlobalUI();</script>
<script>
// Fallback for local file:// where ES modules may be blocked
(function(){
  function inject(){
    var container = document.querySelector("header .container");
    if(!container) return;
    if(container.querySelector(".header-controls")) return;
    var bar = document.createElement("div");
    bar.className = "header-controls";
    bar.innerHTML = '<div class="header-spacer"></div>' +
      '<a class="ctrl" href="index.html" title="Inicio">ğŸ </a>' +
      '<button class="ctrl" title="Narrador" onclick="window._tts=!window._tts; try{var u=new SpeechSynthesisUtterance(window._tts?\'Narrador activado\':\'Narrador desactivado\'); u.lang=\'es-CL\'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){}">ğŸ—£ï¸</button>' +
      '<button class="ctrl" title="Claro/Oscuro" onclick="document.documentElement.classList.toggle(\'light\')">ğŸŒ“</button>' +
      '<button class="ctrl" title="Aumentar letra" onclick="(function(){var r=document.documentElement;var s=parseFloat(getComputedStyle(r).getPropertyValue(\'--scale\')||\'1\');r.style.setProperty(\'--scale\', String(Math.min(1.6,s+0.1)));})();">A+</button>' +
      '<button class="ctrl" title="Disminuir letra" onclick="(function(){var r=document.documentElement;var s=parseFloat(getComputedStyle(r).getPropertyValue(\'--scale\')||\'1\');r.style.setProperty(\'--scale\', String(Math.max(0.8,s-0.1)));})();">Aâˆ’</button>' +
      '<button class="ctrl" title="Idioma" onclick="alert(\'Idioma (placeholder)\')">ğŸŒ</button>' +
      '<button class="ctrl" title="Accesibilidad" onclick="document.documentElement.classList.toggle(\'hc\')">ğŸ§ </button>' +
      '<button class="ctrl" title="Buscar" onclick="(function(){var q=prompt(\'Buscar:\'); if(!q) return; document.querySelectorAll(\'.card,h2,h3\').forEach(function(el){var t=(el.innerText||\'\').toLowerCase(); el.style.outline=t.includes(q.toLowerCase())?\'2px solid var(--accent-2)\':\'\'; el.style.opacity=t.includes(q.toLowerCase())?\'1\':\'0.4\';});})();">ğŸ”</button>';
    container.appendChild(bar);
  }
  if(document.readyState!=="loading") inject();
  else document.addEventListener("DOMContentLoaded", inject);
})();
</script>

</body>
</html>
