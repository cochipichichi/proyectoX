
<!doctype html><html lang="es"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ticket de salida</title><link rel="stylesheet" href="../css/style.css"/>
<script type="module">
import {saveJSON, loadJSON, ts, toCSV, download, sendMail} from "../js/utils.js";
import {initGlobalUI, studentFieldsHTML, getStudent, sendEmailWithAttachment} from "../js/app.js";

function guardar(){
  const alumno = getStudent();
  const r = {
    ts: ts(),
    "1_Cosas que aprendÃ­ hoy": document.querySelector("#p1").value,
    "2_Duda que me quedÃ³": document.querySelector("#p2").value,
    "3_QuÃ© harÃ© distinto la prÃ³xima clase": document.querySelector("#p3").value
  };
  const data = loadJSON("ticket_data",{registros:[]});
  r.alumno = alumno;
  data.registros.push(r);
  saveJSON("ticket_data", data);
  alert("Guardado âœ“");
}

function exportCSV(){
  const data = loadJSON("ticket_data",{registros:[]});
  r.alumno = alumno;
  const csv = toCSV(data.registros);
  download(`ticket_${Date.now()}.csv`, csv);
}

async function mail(){
  const data = loadJSON("ticket_data",{registros:[]});
  r.alumno = alumno;
  const ultimo = data.registros[data.registros.length-1] || {};
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text('Ticket de salida â€” Proyecto X',10,10);
    doc.text(JSON.stringify(ultimo).substring(0,1000),10,18);
    const pdf = doc.output('datauristring');
    await sendEmailWithAttachment('[Piloto] Ticket de salida', JSON.stringify(ultimo,null,2), pdf);
    alert('Enviado con EmailJS');
  }catch(e){ console.error(e); alert('Error al enviar con EmailJS'); }
}

window.addEventListener("DOMContentLoaded", ()=>{
  initGlobalUI();
  document.getElementById('studentFields').innerHTML = studentFieldsHTML();
  document.querySelector("#btnSave").addEventListener("click", guardar);
  document.querySelector("#btnCSV").addEventListener("click", exportCSV);
  document.querySelector("#btnMail").addEventListener("click", mail);
});
</script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script></head>
<body>
<header><div class="container"><a href="../index.html" class="btn ghost">â¬…ï¸ Volver</a>  <strong style="margin-left:12px">Ticket de salida</strong></div></header>
<main class="container grid"><div class="card" id="alumno_box"><h3>ğŸ‘¤ Datos del estudiante</h3><div id="studentFields"></div></div>
  <div class="card"><label>1) Â¿QuÃ© aprendÃ­ hoy?<textarea id="p1" rows="4"></textarea></label></div>
  <div class="card"><label>2) Â¿QuÃ© duda me quedÃ³?<textarea id="p2" rows="4"></textarea></label></div>
  <div class="card"><label>3) Â¿QuÃ© harÃ© distinto la prÃ³xima clase?<textarea id="p3" rows="4"></textarea></label></div>
  <div class="toolbar"><script type="module">import {initGlobalUI,studentFieldsHTML,getStudent,sendEmailWithAttachment} from "../js/app.js";</script>
    <button class="btn" id="btnSave">âœ… Guardar</button>
    <button class="btn secondary" id="btnCSV">âœ… CSV</button>
    <button class="btn ghost" id="btnMail">âœ‰ï¸ Enviar</button>
  </div>
</main>
 <footer class="footer">
  <div>ğŸ“š<strong>Â© Neotech EduLab â€” EducaciÃ³n Inmersiva </strong></div>
  <div>ğŸ› ï¸Prohibida su copia y/o reproduccion</div>
  </footer>
<script type="module">import {initGlobalUI} from "../js/app.js"; initGlobalUI();</script>
<script>
// Fallback for local file:// where ES modules may be blocked
(function(){
  function inject(){
    var container = document.querySelector("header .container");
    if(!container) return;
    if(container.querySelector(".header-controls")) return;
    var bar = document.createElement("div");
    bar.className = "header-controls";
    bar.innerHTML = '<div class="header-spacer"></div>' +
      '<a class="ctrl" href="index.html" title="Inicio">ğŸ </a>' +
      '<button class="ctrl" title="Narrador" onclick="window._tts=!window._tts; try{var u=new SpeechSynthesisUtterance(window._tts?\'Narrador activado\':\'Narrador desactivado\'); u.lang=\'es-CL\'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){}">ğŸ—£ï¸</button>' +
      '<button class="ctrl" title="Claro/Oscuro" onclick="document.documentElement.classList.toggle(\'light\')">ğŸŒ“</button>' +
      '<button class="ctrl" title="Aumentar letra" onclick="(function(){var r=document.documentElement;var s=parseFloat(getComputedStyle(r).getPropertyValue(\'--scale\')||\'1\');r.style.setProperty(\'--scale\', String(Math.min(1.6,s+0.1)));})();">A+</button>' +
      '<button class="ctrl" title="Disminuir letra" onclick="(function(){var r=document.documentElement;var s=parseFloat(getComputedStyle(r).getPropertyValue(\'--scale\')||\'1\');r.style.setProperty(\'--scale\', String(Math.max(0.8,s-0.1)));})();">Aâˆ’</button>' +
      '<button class="ctrl" title="Idioma" onclick="alert(\'Idioma (placeholder)\')">ğŸŒ</button>' +
      '<button class="ctrl" title="Accesibilidad" onclick="document.documentElement.classList.toggle(\'hc\')">ğŸ§ </button>' +
      '<button class="ctrl" title="Buscar" onclick="(function(){var q=prompt(\'Buscar:\'); if(!q) return; document.querySelectorAll(\'.card,h2,h3\').forEach(function(el){var t=(el.innerText||\'\').toLowerCase(); el.style.outline=t.includes(q.toLowerCase())?\'2px solid var(--accent-2)\':\'\'; el.style.opacity=t.includes(q.toLowerCase())?\'1\':\'0.4\';});})();">ğŸ”</button>';
    container.appendChild(bar);
  }
  if(document.readyState!=="loading") inject();
  else document.addEventListener("DOMContentLoaded", inject);
})();
</script>

</body></html>
